<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDM Admin ‚Äî Base clients</title>
  <style>
    :root{
      --bg0:#05070c;
      --glass: rgba(10,14,22,.55);
      --glass2: rgba(10,14,22,.35);
      --border: rgba(255,255,255,.08);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.6);
      --muted2: rgba(255,255,255,.4);
      --gold: #d6b25e;
      --gold2:#f1d58a;
      --red:#ff5b5b;
      --shadow: 0 20px 60px rgba(0,0,0,.55);
      --r: 18px;
      --r2: 26px;
      --sbw: 260px;
    }

    *{box-sizing:border-box}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; color:var(--text); background:var(--bg0); min-height:100vh; overflow-x:hidden;}

    /* Fond ‚Äúcatalogue public‚Äù (d√©grad√©s doux) */
    body:before{
      content:""; position:fixed; inset:-20vh -20vw; z-index:-3;
      background:
        radial-gradient(60vw 60vw at 20% 30%, rgba(20,60,140,.45), transparent 60%),
        radial-gradient(55vw 55vw at 85% 35%, rgba(170,30,40,.38), transparent 62%),
        radial-gradient(45vw 45vw at 55% 85%, rgba(160,130,0,.25), transparent 65%),
        radial-gradient(55vw 55vw at 40% 55%, rgba(0,0,0,.55), transparent 70%),
        linear-gradient(180deg, #04060a 0%, #060a12 55%, #04060a 100%);
      filter: blur(18px) saturate(110%);
    }

    .app{display:flex; min-height:100vh;}

    /* Sidebar */
    .sidebar{
      width: var(--sbw);
      padding: 18px;
      position: sticky; top: 0; height: 100vh;
    }
    .sbCard{
      height:100%;
      background: rgba(10,14,22,.45);
      border: 1px solid var(--border);
      border-radius: 20px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding: 14px;
      display:flex; flex-direction:column;
      gap: 10px;
    }
    .brand{font-weight:800; letter-spacing:.14em; font-size:12px; opacity:.85; margin: 4px 6px 10px;}
    .nav{display:flex; flex-direction:column; gap: 8px; margin-top:4px;}
    .nav a{
      text-decoration:none; color: var(--muted);
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.03);
      transition: .15s ease;
      font-size: 13px;
    }
    .nav a:hover{transform: translateY(-1px); color: var(--text); border-color: rgba(255,255,255,.10);}
    .nav a.active{
      color: #1b1406;
      border-color: rgba(214,178,94,.55);
      background: linear-gradient(180deg, rgba(241,213,138,.95), rgba(214,178,94,.92));
      font-weight: 700;
    }
    .sbSpacer{flex:1}
    .sbBtn{
      width:100%;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
    }

    /* Main */
    .main{flex:1; padding: 18px 18px 30px;}

    /* Topbar */
    .topbar{
      display:flex; align-items:center; gap:10px;
      background: rgba(10,14,22,.35);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 10px 12px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      max-width: 1100px;
      margin: 0 auto 14px;
    }
    .pill{padding: 7px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,.08); background: rgba(255,255,255,.03); font-size: 12px; color: var(--muted);}
    .pill strong{color: var(--text); font-weight: 700;}
    .sp{flex:1}
    .btn{
      border:none; cursor:pointer;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      color: var(--text);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 12px;
    }
    .btn.gold{
      background: linear-gradient(180deg, rgba(241,213,138,.95), rgba(214,178,94,.92));
      color: #1b1406;
      border-color: rgba(214,178,94,.55);
      font-weight: 800;
    }

    /* Cards */
    .wrap{max-width: 1100px; margin: 0 auto;}
    .centerCol{display:flex; flex-direction:column; align-items:center; gap: 14px;}
    .card{
      width: min(1100px, 100%);
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      padding: 14px;
    }
    .card h3{margin: 0 0 8px; letter-spacing:.12em; font-size: 11px; text-transform: uppercase; color: var(--muted);}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .field{flex:1; min-width: 220px;}
    label{display:block; font-size: 11px; color: var(--muted2); margin: 0 0 6px; letter-spacing:.06em; text-transform: uppercase;}
    input, select, textarea{
      width:100%;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline:none;
      font-size: 13px;
    }
    textarea{border-radius: 16px; resize: vertical; min-height: 90px;}
    .hint{font-size: 12px; color: var(--muted2); margin-top: 6px;}

    .actions{display:flex; gap:10px; align-items:center; justify-content:flex-end; flex:1; min-width: 260px;}

    /* Table */
    .tableWrap{overflow:auto; border-radius: 18px; border: 1px solid rgba(255,255,255,.08);}
    table{width:100%; border-collapse: collapse; min-width: 860px;}
    thead th{
      text-align:left;
      font-size: 11px;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: var(--muted);
      padding: 12px 12px;
      background: rgba(255,255,255,.03);
      position: sticky; top: 0;
      backdrop-filter: blur(10px);
    }
    tbody td{padding: 12px; border-top: 1px solid rgba(255,255,255,.06); font-size: 13px; color: rgba(255,255,255,.86);}

    .tag{display:inline-flex; align-items:center; gap:6px; padding: 5px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04); font-size: 12px; color: var(--muted);}

    .tbtn{
      padding: 8px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: var(--text);
      cursor:pointer;
      font-size: 12px;
    }
    .tbtn.red{background: rgba(255,90,90,.12); border-color: rgba(255,90,90,.35); color: rgba(255,200,200,.95); font-weight:700;}

    /* Toast */
    .toast{position: fixed; right: 16px; bottom: 16px; z-index: 50; width: min(420px, calc(100vw - 32px));}
    .toast .box{background: rgba(10,14,22,.92); border: 1px solid rgba(255,255,255,.10); border-radius: 16px; padding: 12px 14px; box-shadow: var(--shadow);}
    .toast .title{font-weight: 800; margin:0 0 4px;}
    .toast .msg{margin:0; color: var(--muted); font-size: 13px;}

    @media (max-width: 980px){
      .sidebar{display:none;}
      .main{padding: 14px 12px 26px;}
      .topbar{max-width:none; margin: 0 0 12px;}
      .wrap{max-width:none;}
    }
  
/* ===== Modal ===== */
.modal.hidden{display:none}
.modal{position:fixed;inset:0;z-index:9999}
.modal__backdrop{position:absolute;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(6px)}
.modal__panel{position:relative;max-width:980px;width:min(980px,calc(100% - 24px));margin:64px auto;background:rgba(10,12,16,.78);border:1px solid rgba(255,255,255,.08);border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.55);overflow:hidden}
.modal__head{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.08)}
.modal__title{font-weight:800;letter-spacing:.4px}
.modal__sub{opacity:.75;font-size:12px;margin-top:2px}
.modal__body{padding:14px 18px 18px}
.modal__stats{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
.pill{display:flex;align-items:baseline;gap:8px;padding:8px 10px;border:1px solid rgba(255,255,255,.08);border-radius:999px;background:rgba(255,255,255,.03)}
.pill span{opacity:.75;font-size:12px}
.pill strong{font-weight:800}
</style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sbCard">
        <div class="brand">PDM ADMIN</div>
        <nav class="nav">
          <a href="pdm-dashboard.html">Dashboard</a>
          <a class="active" href="clients.html">Base clients</a>
          <a href="vehicles.html">Base v√©hicules</a>
          <a href="stock.html">Stock &amp; r√©servations</a>
          <a href="compta.html">Comptabilit√©</a>
        </nav>
        <div class="sbSpacer"></div>
        <button id="sbLogout" class="sbBtn">D√©connexion</button>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <span class="pill"><strong id="rolePill">PDM ADMIN</strong></span>
        <span class="pill" id="mePill">Chargement‚Ä¶</span>
        <div class="sp"></div>
        <a class="btn" href="pdm-dashboard.html">Dashboard</a>
        <button id="logoutBtn" class="btn gold">D√©connexion</button>
      </div>

      <div class="wrap">
        <div class="centerCol">

          <section class="card" id="addCard">
            <h3>Ajouter un client</h3>
            <div class="row">
              <div class="field">
                <label>Nom / Pr√©nom</label>
                <input id="cName" placeholder="Ex. Max Dupont" />
              </div>
              <div class="field">
                <label>T√©l√©phone</label>
                <input id="cPhone" placeholder="Ex. (089)3363" />
              </div>
              <div class="field">
                <label>Permis</label>
                <select id="cLicense">
                  <option value="oui">Oui</option>
                  <option value="non">Non</option>
                  <option value="indisponible">Indisponible</option>
                  <option value="non_demande">Non demand√©</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <div class="field">
                <label>Autorisations</label>
                <div class="row" style="gap:12px">
                  <label style="display:flex; gap:8px; align-items:center; text-transform:none; letter-spacing:0; color: var(--muted); margin:0">
                    <input id="cCar" type="checkbox" style="width:auto" /> Voiture
                  </label>
                  <label style="display:flex; gap:8px; align-items:center; text-transform:none; letter-spacing:0; color: var(--muted); margin:0">
                    <input id="cMoto" type="checkbox" style="width:auto" /> Moto
                  </label>
                  <label style="display:flex; gap:8px; align-items:center; text-transform:none; letter-spacing:0; color: var(--muted); margin:0">
                    <input id="cTruck" type="checkbox" style="width:auto" /> Camion
                  </label>
                </div>
                <div class="hint">Ces cases viennent de ta base Sheets (voiture / moto / camion).</div>
              </div>
              <div class="actions">
                <button id="saveBtn" class="btn gold" style="min-width:160px">Enregistrer</button>
                <button id="resetBtn" class="btn" style="min-width:160px">R√©initialiser</button>
              </div>
            </div>
          </section>

          <section class="card">
            <h3>Importer CSV (Google Sheets)</h3>
            <div class="row">
              <div class="field">
                <label>Fichier CSV</label>
                <input id="csvFile" type="file" accept=".csv,text/csv" />
                <div class="hint">Colonnes attendues : <b>Nom/Pr√©nom</b>, <b>Num√©ro de T√©l√©phone</b>, <b>Permis de Conduire</b>, <b>Voiture</b>, <b>Moto</b>, <b>Camion</b> (les autres colonnes sont ignor√©es).</div>
              </div>
              <div class="actions">
                <button id="importBtn" class="btn gold" style="min-width:160px">Importer</button>
              </div>
            </div>
          </section>

          <section class="card">
            <h3>Base clients</h3>
            <div class="row">
              <div class="field" style="min-width:280px; flex:2">
                <label>Recherche</label>
                <input id="q" placeholder="Nom, t√©l√©phone‚Ä¶" />
              </div>
              <div class="field">
                <label>Tri</label>
                <select id="sortBy">
                  <option value="name_asc">Nom (A‚ÜíZ)</option>
                  <option value="name_desc">Nom (Z‚ÜíA)</option>
                  <option value="phone_asc">T√©l√©phone (A‚ÜíZ)</option>
                  <option value="created_desc">Ajout (r√©cent)</option>
                </select>
              </div>
              <div class="actions">
                <span class="tag" id="countTag">0 client</span>
                <button id="refreshBtn" class="btn">Rafra√Æchir</button>
              </div>
            </div>

            <div class="tableWrap" style="margin-top:12px">
              <table>
                <thead>
                  <tr>
                    <th>Nom</th>
                    <th>T√©l√©phone</th>
                    <th>Permis</th>
              <th>ACHATS</th>
                    <th>Voiture</th>
                    <th>Moto</th>
                    <th>Camion</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="tbody">
                  <tr><td colspan="7" style="color:var(--muted)">Chargement‚Ä¶</td></tr>
                </tbody>
              </table>
            </div>
          </section>

        </div>
      </div>

    </main>
  </div>

  <div id="toast" class="toast" style="display:none"></div>

  <script type="module">
    // ===== Firebase (modular) =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, doc, deleteDoc, updateDoc,
      onSnapshot, query, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // üîß Colle ici ta config Firebase (celle de TON projet)
    const firebaseConfig = {
  apiKey: "AIzaSyAI3qBm_8zltFCTyPyLFNLcY-aU9GI1itM",
  authDomain: "pdm-urban-hills.firebaseapp.com",
  projectId: "pdm-urban-hills",
  storageBucket: "pdm-urban-hills.firebasestorage.app",
  messagingSenderId: "426355558661",
  appId: "1:426355558661:web:8364782043dd5ad2270f6c",
  measurementId: "G-RGM2DWVFLT"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== UI helpers =====
    const $ = (id) => document.getElementById(id);
    const toastEl = $("toast");
    function showToast(title, msg){
      toastEl.style.display = "block";
      toastEl.innerHTML = `
        <div class="box">
          <p class="title">${escapeHtml(title)}</p>
          <p class="msg">${escapeHtml(msg)}</p>
        </div>`;
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toastEl.style.display = "none", 3200);
    }
    function escapeHtml(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    const logoutBtn = $("logoutBtn");
    const sbLogout = $("sbLogout");
    logoutBtn.onclick = sbLogout.onclick = async () => { await signOut(auth); location.href = "index.html"; };

    // ===== Data model =====
    // Firestore: collection "clients"
    // { name, phone, license, car, moto, truck, createdAt, updatedAt }

    const cName = $("cName");
    const cPhone = $("cPhone");
    const cLicense = $("cLicense");
    const cCar = $("cCar");
    const cMoto = $("cMoto");
    const cTruck = $("cTruck");

    const saveBtn = $("saveBtn");
    const resetBtn = $("resetBtn");

    const csvFile = $("csvFile");
    const importBtn = $("importBtn");

    const qEl = $("q");
    const sortBy = $("sortBy");
    const refreshBtn = $("refreshBtn");
    const tbody = $("tbody");
    const countTag = $("countTag");

    let me = null;
    let unsub = null;

    let all = [];

  // ===== Transactions index (for achat count + fiche client) =====
  let txCounts = new Map();      // key -> count
  let txByClient = new Map();    // key -> [tx]
  let txUnsub = null;

  const normKey = (s) => (s || "")
    .toString()
    .trim()
    .toLowerCase()
    .replace(/\s+/g, " ");

  const money = (n) => new Intl.NumberFormat("en-US", { style: "currency", currency: "USD", maximumFractionDigits: 0 })
    .format(Number.isFinite(Number(n)) ? Number(n) : 0);

  function purchaseCountFor(c){
    const key = normKey(c?.name);
    return txCounts.get(key) || 0;
  }

  function buildTxIndex(snapshot){
    const counts = new Map();
    const lists = new Map();
    snapshot.forEach(docu => {
      const d = docu.data() || {};
      const key = normKey(d.client || d.customer || d.nom || d.name);
      if(!key) return;
      counts.set(key, (counts.get(key) || 0) + 1);
      const arr = lists.get(key) || [];
      arr.push({ id: docu.id, ...d });
      lists.set(key, arr);
    });
    // Sort each list by createdAt (if present)
    lists.forEach((arr, k) => {
      arr.sort((a,b)=>{
        const ta = a.createdAt?.seconds ? a.createdAt.seconds : (typeof a.createdAt === "number" ? a.createdAt : 0);
        const tb = b.createdAt?.seconds ? b.createdAt.seconds : (typeof b.createdAt === "number" ? b.createdAt : 0);
        return tb - ta;
      });
    });
    txCounts = counts;
    txByClient = lists;
  }

    let filtered = [];

    function norm(s){ return (s ?? "").toString().trim().toLowerCase(); }

    function licenseLabel(v){
      const x = norm(v);
      if(x === "oui") return "Permis: Oui";
      if(x === "non") return "Permis: Non";
      if(x === "indisponible") return "Permis: Indisponible";
      if(x === "non_demande" || x === "non demand√©" || x === "non_demande") return "Permis: Non demand√©";
      return v || "‚Äî";
    }

    function resetForm(){
      cName.value = "";
      cPhone.value = "";
      cLicense.value = "oui";
      cCar.checked = false;
      cMoto.checked = false;
      cTruck.checked = false;
      saveBtn.dataset.editId = "";
      saveBtn.textContent = "Enregistrer";
    }
    resetBtn.onclick = resetForm;

    async function saveClient(){
      const name = cName.value.trim();
      const phone = cPhone.value.trim();
      const license = cLicense.value;
      const car = !!cCar.checked;
      const moto = !!cMoto.checked;
      const truck = !!cTruck.checked;

      if(!name){ showToast("Client", "Nom / Pr√©nom requis."); return; }

      const payload = { name, phone, license, car, moto, truck, updatedAt: serverTimestamp() };
      const editId = saveBtn.dataset.editId;

      try{
        if(editId){
          await updateDoc(doc(db, "clients", editId), payload);
          showToast("Client", "Client mis √† jour.");
        }else{
          await addDoc(collection(db, "clients"), { ...payload, createdAt: serverTimestamp() });
          showToast("Client", "Client ajout√©.");
        }
        resetForm();
      }catch(e){
        console.error(e);
        showToast("Erreur", e?.message || "Impossible d'enregistrer.");
      }
    }
    saveBtn.onclick = saveClient;

    function applyFilters(){
      const q = norm(qEl.value);
      const so = sortBy.value;

      filtered = all.filter(x => {
        if(!q) return true;
        const blob = norm(`${x.name} ${x.phone} ${licenseLabel(x.license)}`);
        return blob.includes(q);
      });

      const byName = (a,b) => (a.name||"").localeCompare(b.name||"");
      const byPhone = (a,b) => (a.phone||"").localeCompare(b.phone||"");
      const byCreated = (a,b) => (b._ms||0) - (a._ms||0);

      if(so === "name_asc") filtered.sort(byName);
      else if(so === "name_desc") filtered.sort((a,b)=>byName(b,a));
      else if(so === "phone_asc") filtered.sort(byPhone);
      else if(so === "created_desc") filtered.sort(byCreated);

      render();
    }

    function render(){
      countTag.textContent = `${filtered.length} client${filtered.length>1?"s":""}`;
      if(filtered.length === 0){
        tbody.innerHTML = `<tr><td colspan="7" style="color:var(--muted)">Aucun client</td></tr>`;
        return;
      }

      tbody.innerHTML = filtered.map(c => {
        const yes = (v)=> v ? "‚úì" : "‚Äî";
        return `
          <tr>
            <td>${escapeHtml(c.name||"")}</td>
            <td>${escapeHtml(c.phone||"")}</td>
            <td>${escapeHtml(licenseLabel(c.license))}</td>
            <td>${purchaseCountFor(c)}</td>
            <td>${yes(c.car)}</td>
            <td>${yes(c.moto)}</td>
            <td>${yes(c.truck)}</td>
            <td style="white-space:nowrap">
              <button class="tbtn" data-view="${c.id}">Fiche</button>
              <button class="tbtn" data-edit="${c.id}">Modifier</button>
              <button class="tbtn red" data-del="${c.id}">Supprimer</button>
            </td>
          </tr>`;
      }).join("");

      tbody.querySelectorAll("button[data-view]").forEach(b => {
        b.onclick = () => {
          const id = b.dataset.view;
          const c = all.find(x => x.id === id);
          if(c) openClientModal(c);
        };
      });

      tbody.querySelectorAll("button[data-edit]").forEach(b => {
        b.onclick = () => {
          const id = b.dataset.edit;
          const c = all.find(x => x.id === id);
          if(!c) return;
          cName.value = c.name || "";
          cPhone.value = c.phone || "";
          cLicense.value = c.license || "oui";
          cCar.checked = !!c.car;
          cMoto.checked = !!c.moto;
          cTruck.checked = !!c.truck;
          saveBtn.dataset.editId = id;
          saveBtn.textContent = "Mettre √† jour";
          window.scrollTo({top:0, behavior:"smooth"});
        };
      });
      tbody.querySelectorAll("button[data-del]").forEach(b => {
        b.onclick = async () => {
          const id = b.dataset.del;
          if(!confirm("Supprimer ce client ?")) return;
          try{
            await deleteDoc(doc(db, "clients", id));
            showToast("Client", "Supprim√©.");
          }catch(e){
            console.error(e);
            showToast("Erreur", e?.message || "Suppression impossible.");
          }
        };
      });
    }

    // ===== CSV import =====
    function splitCSVLine(line){
      const out = [];
      let cur = "";
      let inQ = false;
      for(let i=0;i<line.length;i++){
        const c = line[i];
        if(c === '"' && line[i+1] === '"'){ cur += '"'; i++; continue; }
        if(c === '"'){ inQ = !inQ; continue; }
        if(c === ',' && !inQ){ out.push(cur); cur = ""; continue; }
        cur += c;
      }
      out.push(cur);
      return out;
    }

    function parseCSV(text){
      const lines = text.replace(/\r/g, "").split("\n").filter(l => l.trim().length);
      if(lines.length === 0) return { header: [], rows: [] };
      const header = splitCSVLine(lines[0]).map(h => h.trim());
      const rows = [];
      for(let i=1;i<lines.length;i++){
        const cols = splitCSVLine(lines[i]);
        const obj = {};
        header.forEach((h, idx) => obj[h] = (cols[idx] ?? "").trim());
        rows.push(obj);
      }
      return { header, rows };
    }

    function getAny(row, keys){
      for(const k of keys){
        if(row[k] != null && row[k] !== "") return row[k];
      }
      return "";
    }

    function parseBool(v){
      const x = norm(v);
      if(!x) return false;
      if(["1","true","vrai","oui","yes","y","x","‚úì","check"].includes(x)) return true;
      return false;
    }

    function normalizeLicense(v){
      const x = norm(v);
      if(["oui","yes","true","1"].includes(x)) return "oui";
      if(["non","no","false","0"].includes(x)) return "non";
      if(["indisponible","na","n/a","nd","indispo"].includes(x)) return "indisponible";
      if(["non demand√©","non_demande","non demande","pas demand√©","pas demande"].includes(x)) return "non_demande";
      return x || "oui";
    }

    importBtn.onclick = async () => {
      const f = csvFile.files?.[0];
      if(!f){ showToast("Import", "Choisis un CSV."); return; }

      try{
        const text = await f.text();
        const parsed = parseCSV(text);
        if(parsed.rows.length === 0){ showToast("Import", "Aucune ligne d√©tect√©e."); return; }

        let ok = 0, skipped = 0;
        for(const r of parsed.rows){
          const name = getAny(r, ["Nom/Pr√©nom","Nom / Pr√©nom","Nom","Pr√©nom","Prenom","Name","nom/pr√©nom","nom"]).toString().trim();
          const phone = getAny(r, ["Num√©ro de T√©l√©phone","Numero de Telephone","T√©l√©phone","Telephone","Phone","phone"]).toString().trim();
          const license = normalizeLicense(getAny(r, ["Permis de Conduire","Permis","Licence","license"]).toString());
          const car = parseBool(getAny(r, ["Voiture","Car","car"]).toString());
          const moto = parseBool(getAny(r, ["Moto","motorbike","moto"]).toString());
          const truck = parseBool(getAny(r, ["Camion","Truck","camion"]).toString());

          if(!name){ skipped++; continue; }

          await addDoc(collection(db, "clients"), {
            name,
            phone,
            license,
            car,
            moto,
            truck,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });
          ok++;
        }
        showToast("Import", `${ok} client(s) import√©(s)${skipped?` ‚Äî ${skipped} ligne(s) ignor√©e(s)`:""}.`);
      }catch(e){
        console.error(e);
        showToast("Erreur import", e?.message || "Import impossible.");
      }
    };

    // ===== Firestore listener =====
    function startListener(){
      if(unsub) unsub();
      const qy = query(collection(db, "clients"), orderBy("name", "asc"));
      unsub = onSnapshot(qy, (snap) => {
        all = snap.docs.map(d => {
          const data = d.data();
          const ms = data.createdAt?.toDate ? data.createdAt.toDate().getTime() : 0;
          return { id: d.id, _ms: ms, ...data };
        });
        applyFilters();
      }, (err) => {
        console.error(err);
        showToast("Firestore", err?.message || "Lecture impossible.");
      });
    }

    // ===== Auth guard =====
    onAuthStateChanged(auth, (user) => {
      if(!user){ location.href = "index.html"; return; }
      me = user;
      $("mePill").textContent = user.email || user.uid;
      if(firebaseConfig.apiKey === "REPLACE_ME"){
        showToast("Config", "‚ö†Ô∏è Colle ta firebaseConfig dans clients.html (REPLACE_ME). ");
        console.warn("firebaseConfig not set. Paste your real config in clients.html.");
      }
      startListener();
    });

    qEl.oninput = applyFilters;
    sortBy.onchange = applyFilters;
    refreshBtn.onclick = () => applyFilters();

  </script>

<!-- ===== Client detail modal ===== -->
<div id="clientModal" class="modal hidden" aria-hidden="true">
  <div class="modal__backdrop" data-close="1"></div>
  <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="clientModalTitle">
    <div class="modal__head">
      <div>
        <div id="clientModalTitle" class="modal__title">Fiche client</div>
        <div id="clientModalSub" class="modal__sub"></div>
      </div>
      <button id="clientModalClose" class="btn btn--ghost">Fermer</button>
    </div>
    <div class="modal__body">
      <div class="modal__stats">
        <div class="pill"><span>Achats</span><strong id="clientModalCount">0</strong></div>
        <div class="pill"><span>Total</span><strong id="clientModalTotal">$0</strong></div>
      </div>
      <div class="tableWrap">
        <table class="table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>V√©hicule</th>
              <th>Prix</th>
              <th>Statut</th>
              <th>Vendeur</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody id="clientModalRows"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

</body>
</html>
