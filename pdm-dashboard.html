<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDM Admin — Dashboard</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <style>
    :root{
      --bg:#050608;
      --bg2:#0b0d11;
      --card:#0e1016cc;
      --card2:#0b0d11cc;
      --line:rgba(255,255,255,.08);
      --text:#f4f4f5;
      --muted:#a0a3ab;
      --gold1:#f5e0a3;
      --gold2:#d4af37;
      --gold3:#f1d58b;
      --blue:#0b2b5b;
      --red:#3b1b23;
      --shadow: 0 22px 80px rgba(0,0,0,.55);
      --radius:18px;
      --radius2:14px;
      --ring: 0 0 0 2px rgba(212,175,55,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background:
        radial-gradient(1200px 700px at 20% 30%, rgba(13,35,88,.55), transparent 55%),
        radial-gradient(900px 600px at 75% 35%, rgba(70,10,18,.55), transparent 55%),
        radial-gradient(1100px 900px at 50% 65%, rgba(0,0,0,.7), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      overflow-x:hidden;
    }
    .wrap{
      width:min(1220px, 92vw);
      margin: 28px auto 80px;
    }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:14px;
      padding: 14px 18px;
      border:1px solid var(--line);
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      position: sticky; top: 12px; z-index: 50;
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 240px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.25);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .title{
      font-weight:700; letter-spacing:.14em;
      text-transform: uppercase;
      font-size:12px;
      color:#fff;
      opacity:.92;
    }
    .role{
      color: var(--gold1);
      border-color: rgba(212,175,55,.25);
    }
    .right{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }
    .btn{
      appearance:none; border:none; cursor:pointer;
      padding: 10px 14px;
      border-radius: 999px;
      font-weight:700; letter-spacing:.08em;
      text-transform: uppercase;
      font-size:11px;
      background: linear-gradient(180deg, var(--gold1), var(--gold2));
      color:#111;
      box-shadow: 0 14px 40px rgba(212,175,55,.18);
      transition: transform .15s ease, filter .15s ease;
    }
    .btn:hover{transform: translateY(-1px); filter:brightness(1.03)}
    .btn.secondary{
      background: transparent;
      color: var(--text);
      border:1px solid var(--line);
      box-shadow:none;
    }
    .btn.danger{
      background: linear-gradient(180deg, #ffb4b4, #ff5e5e);
      color:#1a0606;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-top: 18px;
    }

    .panel{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHead{
      padding: 16px 18px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid var(--line);
      background:
        radial-gradient(900px 500px at 20% 20%, rgba(11,43,91,.25), transparent 55%),
        radial-gradient(900px 500px at 80% 60%, rgba(59,27,35,.25), transparent 55%),
        rgba(0,0,0,.18);
    }
    .panelHead h2{
      margin:0;
      font-size:12px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color:rgba(255,255,255,.9);
    }
    .panelBody{padding: 16px 18px;}
    .muted{color:var(--muted)}
    .note{font-size:12px; color:var(--muted); margin-top:8px; line-height:1.4}

    .stats{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
    }
    .stat{
      border:1px solid var(--line);
      border-radius: var(--radius2);
      background: rgba(0,0,0,.22);
      padding: 12px 14px;
    }
    .stat .k{font-size:11px; letter-spacing:.12em; text-transform:uppercase; color:var(--muted)}
    .stat .v{margin-top:6px; font-size:18px; font-weight:800}
    .stat .s{margin-top:2px; font-size:12px; color:var(--muted)}
    .stat .v.gold{color:var(--gold1)}

    .formGrid{
      display:grid;
      grid-template-columns: 140px 1.2fr 1.4fr 140px 160px 140px;
      gap: 10px;
      align-items:center;
    }
    .field, select, input, textarea{
      width:100%;
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
    }
    textarea{
      border-radius: 14px;
      min-height: 42px;
      resize: vertical;
    }
    .field:focus, select:focus, input:focus, textarea:focus{
      box-shadow: var(--ring);
      border-color: rgba(212,175,55,.35);
    }
    .rowActions{
      display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap:wrap;
    }

    .toolbar{
      display:grid;
      grid-template-columns: 1.6fr 160px 160px 160px 160px 1fr;
      gap: 10px;
      align-items:center;
      margin-bottom: 12px;
    }
    .toolbar .mini{
      font-size:11px; color:var(--muted);
      display:flex; gap:8px; align-items:center;
    }
    .chip{
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      font-size: 12px;
      color: var(--muted);
      display:inline-flex; gap:8px; align-items:center;
      user-select:none;
    }
    .chip input{accent-color: var(--gold2); width:16px; height:16px}

    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
    }
    th, td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      font-size: 12px;
      vertical-align: top;
    }
    th{
      text-align:left;
      color: rgba(255,255,255,.8);
      letter-spacing:.12em;
      text-transform: uppercase;
      font-size: 11px;
      background: rgba(255,255,255,.03);
    }
    tr:hover td{background: rgba(255,255,255,.02)}
    .nowrap{white-space:nowrap}
    .price{font-weight:800; color:var(--gold1)}
    .badge{
      display:inline-flex; padding:6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.25);
      color: var(--muted);
      font-size: 11px;
      white-space:nowrap;
    }
    .badge.ok{border-color: rgba(212,175,55,.25); color: var(--gold1)}
    .badge.wait{border-color: rgba(11,43,91,.35); color:#b7c7ff}
    .badge.no{border-color: rgba(255,130,130,.35); color:#ffb0b0}

    .pagination{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-top: 10px; flex-wrap:wrap;
    }

    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .tab{
      padding: 8px 12px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      color: var(--muted);
      font-size: 12px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background: linear-gradient(180deg, rgba(245,224,163,.18), rgba(212,175,55,.12));
      border-color: rgba(212,175,55,.35);
      color: var(--gold1);
      box-shadow: var(--ring);
    }

    .twoCol{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
    }
    .list{
      border:1px solid var(--line);
      border-radius: 14px;
      overflow:hidden;
      background: rgba(0,0,0,.18);
    }
    .list .item{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .list .item:last-child{border-bottom:none}
    .item .meta{display:flex; flex-direction:column; gap:2px}
    .item .meta b{font-size:13px}
    .item .meta span{font-size:12px; color:var(--muted)}
    .item .tools{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

    .toast{
      position: fixed;
      right: 16px; bottom: 16px;
      background: rgba(0,0,0,.78);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      max-width: min(420px, 90vw);
      display:none;
      z-index: 999;
    }
    .toast b{color: var(--gold1)}
    .toast .small{color:var(--muted); font-size:12px; margin-top:4px}

    /* Mobile */
    @media (max-width: 980px){
      .stats{grid-template-columns: repeat(2, minmax(0, 1fr));}
      .formGrid{grid-template-columns: 1fr 1fr; }
      .toolbar{grid-template-columns: 1fr 1fr; }
      .twoCol{grid-template-columns: 1fr;}
      .brand{min-width: unset;}
    }
    @media (max-width: 640px){
      .wrap{width: 94vw;}
      .topbar{border-radius: 18px}
      .stats{grid-template-columns: 1fr;}
      table{display:none}
      .cards{display:grid; gap:10px}
      .cardRow{
        border:1px solid var(--line);
        border-radius: 14px;
        background: rgba(0,0,0,.18);
        padding: 12px;
      }
      .cardRow .head{display:flex; justify-content:space-between; gap:10px; align-items:flex-start}
      .cardRow .head b{font-size:14px}
      .cardRow .kv{display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:10px}
      .kv div{font-size:12px; color:var(--muted)}
      .kv div b{color:var(--text); font-weight:700}
      .cardRow .tools{margin-top:10px; display:flex; gap:8px; flex-wrap:wrap}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="title">PDM ADMIN</div>
        <div class="pill role" id="meBadge">Chargement…</div>
      </div>
      <div class="right">
        <div class="pill" id="envBadge">Firestore · Live</div>
        <button class="btn secondary" id="toSite">Site</button>
        <button class="btn danger" id="logout">Déconnexion</button>
      </div>
    </div>

    <div class="grid">
      <!-- STATS -->
      <div class="panel">
        <div class="panelHead">
          <h2>Tableau de bord</h2>
          <div class="tabs">
            <div class="tab active" data-tab="transactions">Transactions</div>
            <div class="tab" data-tab="staff">Gestion staff</div>
            <div class="tab" data-tab="audit">Journal</div>
          </div>
        </div>
        <div class="panelBody" id="tab-transactions">
          <div class="stats">
            <div class="stat">
              <div class="k">Total (filtré)</div>
              <div class="v gold" id="statTotal">€ 0</div>
              <div class="s" id="statTotalS">—</div>
            </div>
            <div class="stat">
              <div class="k">Nombre</div>
              <div class="v" id="statCount">0</div>
              <div class="s" id="statCountS">—</div>
            </div>
            <div class="stat">
              <div class="k">Panier moyen</div>
              <div class="v" id="statAvg">€ 0</div>
              <div class="s" id="statAvgS">—</div>
            </div>
            <div class="stat">
              <div class="k">Top vendeur</div>
              <div class="v" id="statTop">—</div>
              <div class="s" id="statTopS">—</div>
            </div>
          </div>
        </div>
      </div>

      <!-- AJOUT -->
      <div class="panel" id="panel-add">
        <div class="panelHead">
          <h2>Nouvelle entrée</h2>
          <div class="pill" id="rightsHint">—</div>
        </div>
        <div class="panelBody">
          <div class="formGrid">
            <select id="fType">
              <option value="vente">Vente</option>
              <option value="reservation">Réservation</option>
            </select>
            <input id="fClient" class="field" placeholder="Client (nom RP)" />
            <input id="fVehicle" class="field" placeholder="Véhicule (Marque + Modèle)" />
            <input id="fPrice" class="field" type="number" placeholder="Prix" />
            <select id="fStatus">
              <option value="en_attente">En attente</option>
              <option value="paye">Payé</option>
              <option value="annule">Annulé</option>
            </select>
            <button class="btn" id="addBtn">Ajouter</button>
          </div>
          <div style="margin-top:10px;">
            <textarea id="fNotes" placeholder="Notes (optionnel)"></textarea>
          </div>
          <div class="note">
            Règles : le staff peut créer et gérer ses propres entrées. L’admin peut tout gérer et gérer les profils staff.
          </div>
        </div>
      </div>

      <!-- HISTORIQUE -->
      <div class="panel">
        <div class="panelHead">
          <h2>Historique</h2>
          <div class="rowActions">
            <button class="btn secondary" id="exportCsv">Exporter CSV</button>
            <label class="btn secondary" id="importLabel" style="display:none;">
              Importer CSV <input id="importCsv" type="file" accept=".csv" style="display:none;" />
            </label>
          </div>
        </div>
        <div class="panelBody">
          <div class="toolbar">
            <input id="q" class="field" placeholder="Rechercher (client, véhicule, vendeur, notes)…" />
            <select id="filterType">
              <option value="all">Tous types</option>
              <option value="vente">Ventes</option>
              <option value="reservation">Réservations</option>
            </select>
            <select id="filterStatus">
              <option value="all">Tous statuts</option>
              <option value="en_attente">En attente</option>
              <option value="paye">Payé</option>
              <option value="annule">Annulé</option>
            </select>
            <select id="filterSeller" style="display:none;"></select>
            <select id="sortBy">
              <option value="date_desc">Tri : date ↓</option>
              <option value="date_asc">Tri : date ↑</option>
              <option value="price_desc">Tri : prix ↓</option>
              <option value="price_asc">Tri : prix ↑</option>
            </select>
            <div class="mini">
              <span class="chip" id="mineChip"><input type="checkbox" id="mineOnly" /> Mes ventes</span>
              <span class="chip" id="resetBtn" style="cursor:pointer;">Réinitialiser</span>
            </div>

            <input id="minPrice" class="field" type="number" placeholder="Prix min" />
            <input id="maxPrice" class="field" type="number" placeholder="Prix max" />
            <input id="fromDate" class="field" type="date" />
            <input id="toDate" class="field" type="date" />
            <select id="pageSize">
              <option value="25">25 / page</option>
              <option value="50">50 / page</option>
              <option value="100">100 / page</option>
            </select>
            <div class="mini muted" id="countInfo">—</div>
          </div>

          <table>
            <thead>
              <tr>
                <th class="nowrap">Date</th>
                <th>Type</th>
                <th>Client</th>
                <th>Véhicule</th>
                <th class="nowrap">Prix</th>
                <th>Statut</th>
                <th>Vendeur</th>
                <th>Notes</th>
                <th class="nowrap">Actions</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>

          <!-- Mobile cards -->
          <div class="cards" id="cards" style="display:none;"></div>

          <div class="pagination">
            <div class="muted" id="pageInfo">—</div>
            <div class="rowActions">
              <button class="btn secondary" id="prevPage">Précédent</button>
              <button class="btn secondary" id="nextPage">Suivant</button>
            </div>
          </div>
        </div>
      </div>

      <!-- STAFF -->
      <div class="panel" id="tab-staff" style="display:none;">
        <div class="panelHead">
          <h2>Gestion staff</h2>
          <div class="pill">Admin uniquement</div>
        </div>
        <div class="panelBody">
          <div class="twoCol">
            <div>
              <div class="muted" style="margin-bottom:10px;">Liste des profils Firestore (collection <b>users</b>).</div>
              <div class="list" id="staffList"></div>
            </div>
            <div>
              <div class="muted" style="margin-bottom:10px;">Créer / mettre à jour un profil staff (après création du compte dans Authentication).</div>
              <div class="panel" style="box-shadow:none;">
                <div class="panelBody">
                  <input id="uUid" class="field" placeholder="UID (depuis Firebase Auth)" />
                  <div style="height:10px"></div>
                  <input id="uName" class="field" placeholder="Nom affiché (RP)" />
                  <div style="height:10px"></div>
                  <select id="uRole">
                    <option value="staff">staff</option>
                    <option value="manager">manager</option>
                    <option value="admin">admin</option>
                  </select>
                  <div style="height:10px"></div>
                  <label class="chip"><input type="checkbox" id="uActive" checked /> Compte actif</label>
                  <div style="height:12px"></div>
                  <button class="btn" id="saveUser">Enregistrer profil</button>
                  <div class="note">
                    Création du compte (email/mot de passe) : à faire dans <b>Firebase Authentication</b>. Ici on gère le profil (rôle, actif, nom).
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- AUDIT -->
      <div class="panel" id="tab-audit" style="display:none;">
        <div class="panelHead">
          <h2>Journal des actions</h2>
          <div class="pill">Admin uniquement</div>
        </div>
        <div class="panelBody">
          <div class="muted" style="margin-bottom:10px;">Traçabilité : ajouts / modifications / suppressions.</div>
          <div class="list" id="auditList"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <div id="toastTitle"><b>Info</b></div>
    <div class="small" id="toastMsg"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import {
      getFirestore, collection, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc,
      query, orderBy, limit, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

     const firebaseConfig = {
   apiKey: "AIzaSyAI3qBm_8zltFCTyPyLFNLcY-aU9GI1itM",
   authDomain: "pdm-urban-hills.firebaseapp.com",
   projectId: "pdm-urban-hills",
   storageBucket: "pdm-urban-hills.firebasestorage.app",
   messagingSenderId: "426355558661",
   appId: "1:426355558661:web:8364782043dd5ad2270f6c",
   measurementId: "G-RGM2DWVFLT"
 };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const meBadge = document.getElementById("meBadge");
    const rightsHint = document.getElementById("rightsHint");
    const toSite = document.getElementById("toSite");
    const logout = document.getElementById("logout");

    const tabs = [...document.querySelectorAll(".tab")];
    const tabTransactions = document.getElementById("tab-transactions");
    const tabStaff = document.getElementById("tab-staff");
    const tabAudit = document.getElementById("tab-audit");

    const fType = document.getElementById("fType");
    const fClient = document.getElementById("fClient");
    const fVehicle = document.getElementById("fVehicle");
    const fPrice = document.getElementById("fPrice");
    const fStatus = document.getElementById("fStatus");
    const fNotes = document.getElementById("fNotes");
    const addBtn = document.getElementById("addBtn");

    const qEl = document.getElementById("q");
    const filterType = document.getElementById("filterType");
    const filterStatus = document.getElementById("filterStatus");
    const filterSeller = document.getElementById("filterSeller");
    const sortBy = document.getElementById("sortBy");
    const mineOnly = document.getElementById("mineOnly");
    const resetBtn = document.getElementById("resetBtn");

    const minPrice = document.getElementById("minPrice");
    const maxPrice = document.getElementById("maxPrice");
    const fromDate = document.getElementById("fromDate");
    const toDate = document.getElementById("toDate");
    const pageSize = document.getElementById("pageSize");
    const countInfo = document.getElementById("countInfo");

    const rows = document.getElementById("rows");
    const cards = document.getElementById("cards");

    const prevPage = document.getElementById("prevPage");
    const nextPage = document.getElementById("nextPage");
    const pageInfo = document.getElementById("pageInfo");

    const exportCsv = document.getElementById("exportCsv");
    const importLabel = document.getElementById("importLabel");
    const importCsv = document.getElementById("importCsv");

    // Stats
    const statTotal = document.getElementById("statTotal");
    const statCount = document.getElementById("statCount");
    const statAvg = document.getElementById("statAvg");
    const statTop = document.getElementById("statTop");
    const statTotalS = document.getElementById("statTotalS");
    const statCountS = document.getElementById("statCountS");
    const statAvgS = document.getElementById("statAvgS");
    const statTopS = document.getElementById("statTopS");

    // Staff
    const staffList = document.getElementById("staffList");
    const uUid = document.getElementById("uUid");
    const uName = document.getElementById("uName");
    const uRole = document.getElementById("uRole");
    const uActive = document.getElementById("uActive");
    const saveUser = document.getElementById("saveUser");

    // Audit
    const auditList = document.getElementById("auditList");

    // Toast
    const toast = document.getElementById("toast");
    const toastTitle = document.getElementById("toastTitle");
    const toastMsg = document.getElementById("toastMsg");
    let toastT = null;

    function showToast(title, msg){
      toastTitle.innerHTML = "<b>" + title + "</b>";
      toastMsg.textContent = msg || "";
      toast.style.display = "block";
      clearTimeout(toastT);
      toastT = setTimeout(() => toast.style.display = "none", 2800);
    }

    function euro(n){
      const x = Number(n || 0);
      return "€ " + x.toLocaleString("fr-FR");
    }
    function fmtDate(ts){
      if(!ts) return "—";
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleString("fr-FR", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }
    function statusBadge(v){
      if(v === "paye") return `<span class="badge ok">Payé</span>`;
      if(v === "annule") return `<span class="badge no">Annulé</span>`;
      return `<span class="badge wait">En attente</span>`;
    }
    function typeLabel(v){
      return v === "reservation" ? "Réservation" : "Vente";
    }
    function norm(s){ return (s||"").toString().toLowerCase().trim(); }

    // State
    let me = null;           // {uid, name, role, active}
    let allTx = [];          // raw snapshot docs mapped
    let filtered = [];       // after client-side filters
    let currentPage = 1;

    function isAdmin(){ return me?.role === "admin"; }
    function canManageStaff(){ return me?.role === "admin"; }
    function canReadAudit(){ return me?.role === "admin"; }

    // Tabs
    function setTab(name){
      tabs.forEach(t => t.classList.toggle("active", t.dataset.tab === name));
      // always visible
      tabTransactions.style.display = (name === "transactions") ? "block" : "none";
      // admin only
      tabStaff.style.display = (name === "staff" && canManageStaff()) ? "block" : "none";
      tabAudit.style.display = (name === "audit" && canReadAudit()) ? "block" : "none";
      if(name === "staff" && !canManageStaff()) showToast("Accès refusé", "Admin uniquement.");
      if(name === "audit" && !canReadAudit()) showToast("Accès refusé", "Admin uniquement.");
    }
    tabs.forEach(t => t.addEventListener("click", () => setTab(t.dataset.tab)));

    toSite.addEventListener("click", () => window.location.href = "./index.html");
    logout.addEventListener("click", async () => { await signOut(auth); window.location.href = "./pdm-staff.html"; });

    // Filters listeners
    const filterInputs = [qEl, filterType, filterStatus, sortBy, mineOnly, minPrice, maxPrice, fromDate, toDate, pageSize, filterSeller];
    filterInputs.forEach(el => el && el.addEventListener("input", () => { currentPage = 1; applyFilters(); render(); }));
    resetBtn.addEventListener("click", () => {
      qEl.value = "";
      filterType.value = "all";
      filterStatus.value = "all";
      sortBy.value = "date_desc";
      minPrice.value = "";
      maxPrice.value = "";
      fromDate.value = "";
      toDate.value = "";
      pageSize.value = "25";
      if(isAdmin()){
        mineOnly.checked = false;
        filterSeller.value = "all";
      } else {
        mineOnly.checked = true;
      }
      currentPage = 1;
      applyFilters(); render();
      showToast("Filtres", "Réinitialisés.");
    });

    prevPage.addEventListener("click", () => { if(currentPage>1){ currentPage--; render(); } });
    nextPage.addEventListener("click", () => {
      const ps = Number(pageSize.value);
      const maxP = Math.max(1, Math.ceil(filtered.length/ps));
      if(currentPage<maxP){ currentPage++; render(); }
    });

    // Add transaction
    addBtn.addEventListener("click", async () => {
      try{
        const type = fType.value;
        const client = fClient.value.trim();
        const vehicle = fVehicle.value.trim();
        const price = Number(fPrice.value);
        const status = fStatus.value;
        const notes = fNotes.value.trim();

        if(!client || !vehicle || !Number.isFinite(price)){
          showToast("Champs manquants", "Client, véhicule et prix sont obligatoires.");
          return;
        }
        const payload = {
          type, client, vehicle, price,
          status,
          notes,
          sellerId: me.uid,
          sellerName: me.name || "Staff",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };

        const ref = await addDoc(collection(db, "transactions"), payload);
        await addAudit("create", "transaction", ref.id, payload);
        fClient.value = ""; fVehicle.value = ""; fPrice.value = ""; fNotes.value = "";
        showToast("Ajout", "Transaction enregistrée.");
      }catch(err){
        console.error(err);
        showToast("Erreur", err?.message || "Impossible d'ajouter.");
      }
    });

    // Export CSV
    exportCsv.addEventListener("click", () => {
      const rows = filtered.map(x => ({
        date: x.createdAt ? fmtDate(x.createdAt) : "",
        type: x.type || "",
        client: x.client || "",
        vehicle: x.vehicle || "",
        price: x.price ?? "",
        status: x.status || "",
        sellerName: x.sellerName || "",
        sellerId: x.sellerId || "",
        notes: (x.notes || "").replace(/\n/g, " ")
      }));
      const header = ["date","type","client","vehicle","price","status","sellerName","sellerId","notes"];
      const csv = [
        header.join(","),
        ...rows.map(r => header.map(k => {
          const v = (r[k] ?? "").toString();
          const safe = v.includes(",") || v.includes('"') ? `"${v.replace(/"/g,'""')}"` : v;
          return safe;
        }).join(","))
      ].join("\n");

      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `pdm_transactions_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      showToast("Export", "CSV généré.");
    });

    // Import CSV (admin only)
    importCsv.addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      e.target.value = "";
      if(!file) return;
      if(!isAdmin()){
        showToast("Accès refusé", "Import CSV réservé à l'admin.");
        return;
      }
      try{
        const text = await file.text();
        const parsed = parseCSV(text);
        if(parsed.rows.length === 0){
          showToast("Import", "Aucune ligne détectée.");
          return;
        }

        // Mapping accepté : client, vehicle, price, type, status, notes, sellerName (optionnel)
        let ok = 0;
        for(const r of parsed.rows){
          const client = (r.client ?? r.Client ?? r.CLIENT ?? "").toString().trim();
          const vehicle = (r.vehicle ?? r.Vehicule ?? r.vehicule ?? "").toString().trim();
          const price = Number(r.price ?? r.Prix ?? r.prix);
          if(!client || !vehicle || !Number.isFinite(price)) continue;

          const payload = {
            type: (r.type ?? r.Type ?? "vente").toString().trim().toLowerCase() === "reservation" ? "reservation" : "vente",
            client,
            vehicle,
            price,
            status: normalizeStatus((r.status ?? r.Statut ?? "en_attente").toString()),
            notes: (r.notes ?? r.Notes ?? "").toString(),
            sellerId: me.uid,
            sellerName: (r.sellerName ?? r.Vendeur ?? me.name || "Admin").toString(),
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          };
          const ref = await addDoc(collection(db, "transactions"), payload);
          await addAudit("import", "transaction", ref.id, payload);
          ok++;
        }
        showToast("Import", `${ok} lignes importées.`);
      }catch(err){
        console.error(err);
        showToast("Erreur import", err?.message || "Import impossible.");
      }
    });

    function normalizeStatus(s){
      const v = norm(s);
      if(v.includes("pay")) return "paye";
      if(v.includes("ann")) return "annule";
      return "en_attente";
    }

    function parseCSV(text){
      // simple parser compatible with quotes
      const lines = text.replace(/\r/g,"").split("\n").filter(l => l.trim().length);
      if(lines.length === 0) return {header:[], rows:[]};

      const header = splitCSVLine(lines[0]).map(h => h.trim());
      const rows = [];
      for(let i=1;i<lines.length;i++){
        const cols = splitCSVLine(lines[i]);
        const obj = {};
        header.forEach((h, idx) => obj[h] = (cols[idx] ?? "").trim());
        rows.push(obj);
      }
      return {header, rows};
    }
    function splitCSVLine(line){
      const out = [];
      let cur = "";
      let inQ = false;
      for(let i=0;i<line.length;i++){
        const c = line[i];
        if(c === '"' && line[i+1] === '"'){ cur += '"'; i++; continue; }
        if(c === '"'){ inQ = !inQ; continue; }
        if(c === "," && !inQ){ out.push(cur); cur=""; continue; }
        cur += c;
      }
      out.push(cur);
      return out;
    }

    // Render + filters
    function applyFilters(){
      const q = norm(qEl.value);
      const t = filterType.value;
      const st = filterStatus.value;
      const so = sortBy.value;
      const mine = mineOnly.checked;
      const minP = minPrice.value ? Number(minPrice.value) : null;
      const maxP = maxPrice.value ? Number(maxPrice.value) : null;
      const fd = fromDate.value ? new Date(fromDate.value + "T00:00:00") : null;
      const td = toDate.value ? new Date(toDate.value + "T23:59:59") : null;
      const seller = isAdmin() ? (filterSeller.value || "all") : "all";

      filtered = allTx.filter(x => {
        if(t !== "all" && x.type !== t) return false;
        if(st !== "all" && x.status !== st) return false;
        if(mine && x.sellerId !== me.uid) return false;
        if(isAdmin() && seller !== "all" && x.sellerId !== seller) return false;

        if(minP != null && Number(x.price) < minP) return false;
        if(maxP != null && Number(x.price) > maxP) return false;

        const d = x.createdAt?.toDate ? x.createdAt.toDate() : null;
        if(fd && d && d < fd) return false;
        if(td && d && d > td) return false;

        if(q){
          const blob = norm(`${x.client} ${x.vehicle} ${x.sellerName} ${x.notes} ${x.status} ${x.type}`);
          if(!blob.includes(q)) return false;
        }
        return true;
      });

      // Sort
      const byDate = (a,b) => (a._ms||0) - (b._ms||0);
      const byPrice = (a,b) => (Number(a.price||0) - Number(b.price||0));
      if(so === "date_desc") filtered.sort((a,b)=> byDate(b,a));
      if(so === "date_asc") filtered.sort((a,b)=> byDate(a,b));
      if(so === "price_desc") filtered.sort((a,b)=> byPrice(b,a));
      if(so === "price_asc") filtered.sort((a,b)=> byPrice(a,b));

      // Stats
      const sum = filtered.reduce((acc,x)=> acc + Number(x.price||0), 0);
      statTotal.textContent = euro(sum);
      statCount.textContent = String(filtered.length);
      statAvg.textContent = euro(filtered.length ? Math.round(sum/filtered.length) : 0);

      const bySeller = new Map();
      for(const x of filtered){
        const k = x.sellerName || "—";
        bySeller.set(k, (bySeller.get(k)||0) + Number(x.price||0));
      }
      let top = "—", topV = 0;
      for(const [k,v] of bySeller.entries()){
        if(v > topV){ topV = v; top = k; }
      }
      statTop.textContent = top;
      statTopS.textContent = topV ? euro(topV) : "—";

      statTotalS.textContent = `Sur ${filtered.length} entrée(s)`;
      statCountS.textContent = mineOnly.checked ? "Filtre : Mes ventes" : "—";
      statAvgS.textContent = (filterStatus.value !== "all") ? `Statut : ${filterStatus.options[filterStatus.selectedIndex].text}` : "—";

      const ps = Number(pageSize.value);
      const maxP = Math.max(1, Math.ceil(filtered.length/ps));
      if(currentPage > maxP) currentPage = maxP;

      countInfo.textContent = `${filtered.length} résultat(s)`;
    }

    function render(){
      const ps = Number(pageSize.value);
      const maxP = Math.max(1, Math.ceil(filtered.length/ps));
      const start = (currentPage-1)*ps;
      const pageItems = filtered.slice(start, start+ps);

      pageInfo.textContent = `Page ${currentPage} / ${maxP}`;

      // Desktop table
      rows.innerHTML = pageItems.map(x => {
        const canEdit = isAdmin() || x.sellerId === me.uid;
        const canDelete = isAdmin() || x.sellerId === me.uid;
        return `
          <tr>
            <td class="nowrap">${fmtDate(x.createdAt)}</td>
            <td>${typeLabel(x.type)}</td>
            <td>${escapeHtml(x.client)}</td>
            <td>${escapeHtml(x.vehicle)}</td>
            <td class="nowrap price">${euro(x.price)}</td>
            <td>${statusBadge(x.status)}</td>
            <td>${escapeHtml(x.sellerName || "—")}</td>
            <td>${escapeHtml((x.notes||"").slice(0,80))}</td>
            <td class="nowrap">
              <button class="btn secondary" data-act="edit" data-id="${x.id}" ${canEdit ? "" : "disabled"}>Modifier</button>
              <button class="btn danger" data-act="del" data-id="${x.id}" ${canDelete ? "" : "disabled"}>Supprimer</button>
            </td>
          </tr>
        `;
      }).join("");

      // Mobile cards
      const isMobile = window.matchMedia("(max-width: 640px)").matches;
      if(isMobile){
        cards.style.display = "grid";
        document.querySelector("table").style.display = "none";
        cards.innerHTML = pageItems.map(x => {
          const canEdit = isAdmin() || x.sellerId === me.uid;
          const canDelete = isAdmin() || x.sellerId === me.uid;
          return `
            <div class="cardRow">
              <div class="head">
                <div>
                  <b>${escapeHtml(x.vehicle)}</b><div class="muted" style="font-size:12px">${escapeHtml(x.client)}</div>
                </div>
                <div class="price">${euro(x.price)}</div>
              </div>
              <div class="kv">
                <div><b>Date</b><br>${fmtDate(x.createdAt)}</div>
                <div><b>Type</b><br>${typeLabel(x.type)}</div>
                <div><b>Statut</b><br>${stripHtml(statusBadge(x.status))}</div>
                <div><b>Vendeur</b><br>${escapeHtml(x.sellerName||"—")}</div>
              </div>
              ${x.notes ? `<div class="muted" style="margin-top:8px">${escapeHtml(x.notes)}</div>` : ""}
              <div class="tools">
                <button class="btn secondary" data-act="edit" data-id="${x.id}" ${canEdit ? "" : "disabled"}>Modifier</button>
                <button class="btn danger" data-act="del" data-id="${x.id}" ${canDelete ? "" : "disabled"}>Supprimer</button>
              </div>
            </div>
          `;
        }).join("");
      } else {
        cards.style.display = "none";
        document.querySelector("table").style.display = "table";
      }

      // bind row actions
      [...document.querySelectorAll("[data-act]")].forEach(b => {
        b.addEventListener("click", async () => {
          const id = b.dataset.id;
          const act = b.dataset.act;
          const item = allTx.find(x => x.id === id);
          if(!item) return;

          if(act === "del"){
            const ok = confirm("Supprimer cette entrée ? (action irréversible)");
            if(!ok) return;
            try{
              await deleteDoc(doc(db, "transactions", id));
              await addAudit("delete", "transaction", id, item);
              showToast("Suppression", "Entrée supprimée.");
            }catch(err){
              console.error(err);
              showToast("Erreur", err?.message || "Suppression impossible.");
            }
          }

          if(act === "edit"){
            const client = prompt("Client", item.client || "") ?? item.client;
            const vehicle = prompt("Véhicule", item.vehicle || "") ?? item.vehicle;
            const price = Number(prompt("Prix", String(item.price ?? 0)) ?? item.price);
            const status = prompt("Statut (en_attente / paye / annule)", item.status || "en_attente") ?? item.status;
            const notes = prompt("Notes", item.notes || "") ?? item.notes;

            try{
              await updateDoc(doc(db, "transactions", id), {
                client: client.toString().trim(),
                vehicle: vehicle.toString().trim(),
                price: Number.isFinite(price) ? price : Number(item.price||0),
                status: normalizeStatus(status.toString()),
                notes: notes.toString(),
                updatedAt: serverTimestamp()
              });
              await addAudit("update", "transaction", id, { before:item, after:{client,vehicle,price,status,notes} });
              showToast("Modification", "Entrée mise à jour.");
            }catch(err){
              console.error(err);
              showToast("Erreur", err?.message || "Modification impossible.");
            }
          }
        });
      });
    }

    function escapeHtml(s){
      return (s||"").toString()
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function stripHtml(s){
      return (s||"").toString().replace(/<[^>]*>/g,"").trim();
    }

    // Audit logs
    async function addAudit(action, entity, entityId, payload){
      try{
        await addDoc(collection(db, "auditLogs"), {
          action,
          entity,
          entityId,
          actorId: me.uid,
          actorName: me.name || "—",
          createdAt: serverTimestamp(),
          payload: payload ?? null
        });
      }catch(e){
        // ne bloque jamais l'app si audit échoue
        console.warn("audit failed", e);
      }
    }

    // Staff management (admin)
    saveUser.addEventListener("click", async () => {
      if(!isAdmin()){
        showToast("Accès refusé", "Admin uniquement.");
        return;
      }
      const uid = uUid.value.trim();
      const name = uName.value.trim();
      const role = uRole.value;
      const active = !!uActive.checked;
      if(!uid || !name){
        showToast("Champs manquants", "UID + Nom requis.");
        return;
      }
      try{
        await setDoc(doc(db, "users", uid), { name, role, active, updatedAt: serverTimestamp() }, { merge:true });
        await addAudit("upsert", "user", uid, { name, role, active });
        showToast("Profil staff", "Enregistré.");
        uUid.value=""; uName.value=""; uRole.value="staff"; uActive.checked=true;
      }catch(err){
        console.error(err);
        showToast("Erreur", err?.message || "Impossible d'enregistrer.");
      }
    });

    // Realtime listeners
    let unsubTx = null;
    let unsubUsers = null;
    let unsubAudit = null;

    function startListeners(){
      // Transactions
      const txQ = query(collection(db, "transactions"), orderBy("createdAt","desc"), limit(800));
      unsubTx = onSnapshot(txQ, (snap) => {
        allTx = snap.docs.map(d => {
          const data = d.data();
          const ms = data.createdAt?.toDate ? data.createdAt.toDate().getTime() : 0;
          return { id:d.id, ...data, _ms: ms };
        });
        applyFilters();
        render();
      }, (err) => {
        console.error(err);
        showToast("Erreur Firestore", err?.message || "Lecture impossible.");
      });

      // Users for admin + seller filter
      if(isAdmin()){
        filterSeller.style.display = "block";
        importLabel.style.display = "inline-flex";

        const uQ = query(collection(db, "users"), orderBy("name","asc"), limit(300));
        unsubUsers = onSnapshot(uQ, (snap) => {
          const users = snap.docs.map(d => ({ uid:d.id, ...d.data() }));
          buildSellerFilter(users);
          renderStaff(users);
        });

        // Audit
        const aQ = query(collection(db, "auditLogs"), orderBy("createdAt","desc"), limit(200));
        unsubAudit = onSnapshot(aQ, (snap) => {
          const logs = snap.docs.map(d => ({ id:d.id, ...d.data() }));
          renderAudit(logs);
        });
      } else {
        mineOnly.checked = true; // staff default
        filterSeller.style.display = "none";
        importLabel.style.display = "none";
      }
    }

    function buildSellerFilter(users){
      const current = filterSeller.value || "all";
      filterSeller.innerHTML = `<option value="all">Tous vendeurs</option>` + users
        .filter(u => u.active)
        .map(u => `<option value="${u.uid}">${escapeHtml(u.name)} · ${escapeHtml(u.role||"")}</option>`)
        .join("");
      filterSeller.value = current === "" ? "all" : current;
    }

    function renderStaff(users){
      staffList.innerHTML = users.map(u => `
        <div class="item">
          <div class="meta">
            <b>${escapeHtml(u.name || "—")}</b>
            <span>role: ${escapeHtml(u.role || "staff")} · active: ${u.active ? "true" : "false"} · uid: ${escapeHtml(u.uid)}</span>
          </div>
          <div class="tools">
            <button class="btn secondary" data-uedit="${u.uid}">Éditer</button>
            <button class="btn secondary" data-utoggle="${u.uid}">${u.active ? "Désactiver" : "Activer"}</button>
          </div>
        </div>
      `).join("") || `<div class="item"><div class="meta"><b>Aucun profil</b><span>Crée tes profils staff dans la collection users.</span></div></div>`;

      [...document.querySelectorAll("[data-uedit]")].forEach(btn => {
        btn.addEventListener("click", () => {
          const uid = btn.dataset.uedit;
          const u = users.find(x => x.uid === uid);
          if(!u) return;
          uUid.value = u.uid;
          uName.value = u.name || "";
          uRole.value = u.role || "staff";
          uActive.checked = !!u.active;
          showToast("Edition", "Profil chargé dans le formulaire.");
          setTab("staff");
        });
      });

      [...document.querySelectorAll("[data-utoggle]")].forEach(btn => {
        btn.addEventListener("click", async () => {
          const uid = btn.dataset.utoggle;
          const u = users.find(x => x.uid === uid);
          if(!u) return;
          try{
            await updateDoc(doc(db, "users", uid), { active: !u.active, updatedAt: serverTimestamp() });
            await addAudit("toggle", "user", uid, { active: !u.active });
            showToast("Profil staff", !u.active ? "Activé." : "Désactivé.");
          }catch(err){
            console.error(err);
            showToast("Erreur", err?.message || "Impossible.");
          }
        });
      });
    }

    function renderAudit(logs){
      auditList.innerHTML = logs.map(l => `
        <div class="item">
          <div class="meta">
            <b>${escapeHtml(l.actorName || "—")} · ${escapeHtml(l.action || "")}</b>
            <span>${fmtDate(l.createdAt)} · ${escapeHtml(l.entity || "")} · ${escapeHtml(l.entityId || "")}</span>
          </div>
          <div class="tools">
            <span class="badge">${escapeHtml(l.entity || "")}</span>
          </div>
        </div>
      `).join("") || `<div class="item"><div class="meta"><b>Aucun log</b><span>Le journal se remplira avec les actions staff/admin.</span></div></div>`;
    }

    onAuthStateChanged(auth, async (user) => {
  // refs UI (si pas déjà en haut chez toi)
  const meBadge = document.getElementById("meBadge");

  if (!user) {
    window.location.href = "./pdm-staff.html";
    return;
  }

  // Affichage temporaire (et sûr)
  if (meBadge) meBadge.textContent = "Chargement...";

  try {
    const ref = doc(db, "users", user.uid);
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      if (meBadge) meBadge.textContent = "Compte non configuré";
      return;
    }

    const data = snap.data();

    // ⚠️ toi tu as: Active / name / role
    const isActive = data.Active === true || data.active === true;
    const name = data.name || "Utilisateur";
    const role = (data.role || "staff").toLowerCase(); // "admin" ou "staff"

    if (!isActive) {
      if (meBadge) meBadge.textContent = "Compte désactivé";
      return;
    }

    // ✅ Affichage badge propre
    if (meBadge) {
      meBadge.textContent = role === "admin" ? `${name} — ADMIN` : `${name} — STAFF`;
    }

    // ✅ (Optionnel) sécurité: empêcher un staff d’accéder au dashboard admin
    // si ton dashboard est "admin only", décommente :
    // if (role !== "admin") window.location.href = "./pdm-staff.html";

  } catch (e) {
    console.error("Erreur chargement profil:", e);
    if (meBadge) meBadge.textContent = "Erreur profil";
  }
});
    // Responsive rerender
    window.addEventListener("resize", () => render());
  </script>
</body>
</html>
